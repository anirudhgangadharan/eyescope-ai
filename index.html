<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1565C0">
    <title>EyeScopeAI v2.1</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #1565C0; --primary-dark: #0D47A1; --accent: #FF6F00; --success: #4CAF50; --error: #F44336; --gray: #9E9E9E; --gray-light: #F5F5F5; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: white; min-height: 100vh; overflow-x: hidden; user-select: none; }
        .screen { display: none; width: 100%; min-height: 100vh; flex-direction: column; }
        .screen.active { display: flex; }
        
        #homeScreen { justify-content: flex-start; align-items: center; padding: 16px; text-align: center; overflow-y: auto; }
        .logo { font-size: 48px; margin-bottom: 6px; margin-top: 8px; }
        .title { font-size: 26px; font-weight: bold; color: var(--primary-dark); margin-bottom: 2px; }
        .subtitle { font-size: 13px; color: var(--gray); margin-bottom: 12px; }
        
        .calibration-status { font-size: 12px; padding: 5px 12px; border-radius: 16px; margin-bottom: 12px; }
        .calibration-status.calibrated { background: #E8F5E9; color: var(--success); }
        .calibration-status.not-calibrated { background: #FFF3E0; color: var(--accent); }
        
        .card { background: white; border-radius: 10px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 12px; width: 100%; max-width: 360px; text-align: left; }
        .card h3 { color: var(--primary); margin-bottom: 8px; font-size: 15px; }
        .card li { font-size: 12px; line-height: 1.4; color: #333; }
        .card ol { padding-left: 16px; }
        
        .input-group { width: 100%; max-width: 360px; margin-bottom: 12px; }
        .input-group label { display: block; font-size: 12px; color: var(--gray); margin-bottom: 4px; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; outline: none; }
        .input-group input:focus { border-color: var(--primary); }
        .input-group input.error { border-color: var(--error); }
        
        .btn { padding: 12px 24px; font-size: 15px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; width: 100%; max-width: 360px; margin-bottom: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-small { padding: 10px 18px; font-size: 13px; }
        
        .version { font-size: 10px; color: var(--gray); margin-top: 12px; }
        .sync-status { font-size: 10px; padding: 2px 8px; border-radius: 8px; margin-top: 4px; }
        .sync-status.online { background: #E8F5E9; color: var(--success); }
        .sync-status.offline { background: #FFF3E0; color: var(--accent); }
        
        /* Optotype Selector */
        .optotype-selector { width: 100%; max-width: 360px; margin-bottom: 12px; }
        .optotype-selector label { display: block; font-size: 12px; color: var(--gray); margin-bottom: 8px; }
        .optotype-options { display: flex; gap: 6px; }
        .optotype-option { flex: 1; padding: 10px 6px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; }
        .optotype-option.selected { border-color: var(--primary); background: #E3F2FD; }
        .optotype-option .symbol { font-size: 28px; font-weight: bold; display: block; }
        .optotype-option .name { font-size: 11px; color: #333; font-weight: 600; }
        .optotype-option .desc { font-size: 9px; color: var(--gray); }
        
        .ring-preview { width: 28px; height: 28px; margin: 0 auto 2px; border: 4px solid black; border-radius: 50%; position: relative; }
        .ring-preview::after { content: ''; position: absolute; background: white; }
        .ring-preview.c::after { right: -5px; top: 50%; transform: translateY(-50%); width: 10px; height: 7px; }
        
        .square-u-preview { width: 22px; height: 22px; margin: 3px auto 4px; border: 4px solid black; border-top: none; background: white; }
        
        /* Calibration */
        #calibrationScreen { justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .cal-title { font-size: 20px; font-weight: bold; color: var(--primary-dark); margin-bottom: 6px; }
        .cal-inst { font-size: 14px; color: var(--gray); margin-bottom: 16px; max-width: 280px; }
        .cal-box-wrap { position: relative; margin: 16px 0; }
        .cal-box { border: 3px solid var(--primary); background: rgba(21,101,192,0.1); }
        .cal-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 13px; color: var(--primary-dark); font-weight: bold; }
        .cal-controls { display: flex; gap: 10px; margin-bottom: 16px; align-items: center; }
        .cal-controls button { width: 50px; height: 50px; font-size: 24px; border-radius: 50%; border: 2px solid var(--primary); background: white; color: var(--primary); }
        .cal-controls button:active { background: var(--primary); color: white; }
        .cal-size { font-size: 14px; color: var(--primary-dark); min-width: 90px; text-align: center; }
        .cal-hint { font-size: 11px; color: var(--gray); margin-bottom: 16px; }
        .fine-tune { display: flex; gap: 6px; margin-bottom: 16px; }
        
        /* Distance */
        #distanceScreen { justify-content: center; align-items: center; padding: 20px; text-align: center; background: linear-gradient(135deg, #E3F2FD, #BBDEFB); }
        .dist-icon { font-size: 56px; margin-bottom: 12px; }
        .dist-title { font-size: 22px; font-weight: bold; color: var(--primary-dark); margin-bottom: 8px; }
        .dist-value { font-size: 56px; font-weight: bold; color: var(--primary); margin-bottom: 6px; }
        .dist-inst { font-size: 15px; color: #333; margin-bottom: 20px; max-width: 280px; line-height: 1.4; }
        .dist-tips { background: white; border-radius: 10px; padding: 12px; margin-bottom: 20px; max-width: 280px; text-align: left; }
        .dist-tips h4 { color: var(--primary); margin-bottom: 6px; font-size: 13px; }
        .dist-tips li { font-size: 12px; margin-bottom: 3px; color: #333; }
        
        /* Test Screen */
        #testScreen { background: white; }
        .test-header { background: var(--primary); color: white; padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; }
        .eye-ind { font-size: 15px; font-weight: bold; }
        .prog-text { font-size: 12px; opacity: 0.9; }
        .acuity-bar { background: var(--gray-light); padding: 5px; text-align: center; font-size: 10px; color: var(--gray); }
        
        .test-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 40vh; padding: 16px; }
        
        .tumbling-e { font-family: 'Arial Black', Arial, sans-serif; font-weight: 900; color: black; line-height: 1; }
        .landolt-c { position: relative; border-radius: 50%; background: radial-gradient(circle, white 0%, white 50%, black 50%, black 100%); }
        .landolt-c .gap { position: absolute; background: white; }
        .landolt-c.gap-right .gap { right: 0; top: 35%; width: 55%; height: 30%; }
        .landolt-c.gap-left .gap { left: 0; top: 35%; width: 55%; height: 30%; }
        .landolt-c.gap-up .gap { top: 0; left: 35%; width: 30%; height: 55%; }
        .landolt-c.gap-down .gap { bottom: 0; left: 35%; width: 30%; height: 55%; }
        
        /* Square U - distinct from circular Landolt C */
        .square-u { position: relative; background: black; }
        .square-u .inner { position: absolute; background: white; }
        .square-u.gap-down .inner { left: 20%; right: 20%; top: 20%; bottom: 0; }
        .square-u.gap-up .inner { left: 20%; right: 20%; top: 0; bottom: 20%; }
        .square-u.gap-left .inner { left: 0; right: 20%; top: 20%; bottom: 20%; }
        .square-u.gap-right .inner { left: 20%; right: 0; top: 20%; bottom: 20%; }
        
        /* Eye indicator overlay */
        .eye-overlay { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 8px 24px; border-radius: 20px; font-size: 18px; font-weight: bold; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        
        .feedback-bar { height: 5px; background: var(--gray-light); }
        .feedback-bar.correct { background: var(--success); }
        .feedback-bar.incorrect { background: var(--error); }
        
        /* Direction Buttons */
        .dir-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; width: 100%; max-width: 260px; padding: 12px; background: var(--gray-light); }
        .dir-btn { width: 100%; aspect-ratio: 1; border: none; border-radius: 10px; font-size: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .dir-btn:active { transform: scale(0.95); }
        .dir-btn.up { grid-column: 2; grid-row: 1; background: var(--primary); color: white; }
        .dir-btn.left { grid-column: 1; grid-row: 2; background: var(--primary); color: white; }
        .dir-btn.center { grid-column: 2; grid-row: 2; background: #ddd; color: var(--gray); font-size: 12px; }
        .dir-btn.right { grid-column: 3; grid-row: 2; background: var(--primary); color: white; }
        .dir-btn.down { grid-column: 2; grid-row: 3; background: var(--primary); color: white; }
        .dir-btn.cant { grid-column: 1/4; grid-row: 4; background: var(--error); color: white; aspect-ratio: auto; padding: 12px; font-size: 14px; margin-top: 6px; }
        
        /* Results */
        #resultsScreen { justify-content: center; align-items: center; padding: 16px; overflow-y: auto; }
        .check-icon { font-size: 48px; color: var(--success); margin-bottom: 10px; }
        .results-card { background: white; border-radius: 10px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); width: 100%; max-width: 360px; margin-bottom: 16px; }
        .results-card h2 { color: var(--primary); margin-bottom: 12px; font-size: 17px; }
        .subj-id { font-size: 12px; color: var(--gray); margin-bottom: 12px; }
        .eye-result { background: var(--gray-light); padding: 10px; border-radius: 8px; margin-bottom: 8px; }
        .eye-result h4 { color: var(--primary-dark); margin-bottom: 5px; font-size: 14px; }
        .eye-result p { font-size: 14px; margin: 2px 0; }
        .eye-result .dec { font-size: 12px; color: var(--gray); }
        .timestamp { font-size: 10px; color: var(--gray); margin-top: 12px; }
        .btn-group { width: 100%; max-width: 360px; }
        
        .save-status { text-align: center; padding: 8px; border-radius: 6px; margin-bottom: 12px; font-size: 12px; }
        .save-status.saving { background: #E3F2FD; color: var(--primary); }
        .save-status.saved { background: #E8F5E9; color: var(--success); }
        .save-status.error { background: #FFEBEE; color: var(--error); }
        .save-status.queued { background: #FFF3E0; color: var(--accent); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; max-width: 280px; text-align: center; }
        .modal-content h3 { color: var(--primary-dark); margin-bottom: 12px; font-size: 17px; }
        .modal-content p { margin-bottom: 16px; line-height: 1.4; font-size: 13px; }
        
        .pending-badge { position: fixed; top: 6px; right: 6px; background: var(--accent); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; display: none; z-index: 100; }
        .pending-badge.show { display: block; }
        .opto-badge { position: fixed; top: 6px; left: 6px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; z-index: 100; }
        .dist-badge { background: var(--accent); padding: 1px 4px; border-radius: 4px; margin-left: 3px; }
    </style>
</head>
<body>
    <div id="pendingBadge" class="pending-badge"></div>
    <div id="optoBadge" class="opto-badge" style="display:none;"></div>

    <!-- Home -->
    <div id="homeScreen" class="screen active">
        <div class="logo">üëÅÔ∏è</div>
        <div class="title">EyeScopeAI</div>
        <div class="subtitle">Vision Screening v2.1</div>
        <div id="calStatus" class="calibration-status not-calibrated">‚ö†Ô∏è Not calibrated</div>
        
        <div class="card">
            <h3>üìã Protocol (2 meters)</h3>
            <ol>
                <li>Calibrate screen (one-time)</li>
                <li>Mount phone at eye level</li>
                <li>Student stands <strong>2m</strong> away</li>
                <li>Tap direction of opening</li>
            </ol>
        </div>
        
        <div class="optotype-selector">
            <label>Optotype</label>
            <div class="optotype-options">
                <div class="optotype-option selected" data-type="E" onclick="selectOpto('E')">
                    <span class="symbol">E</span>
                    <div class="name">Tumbling E</div>
                    <div class="desc">ETDRS</div>
                </div>
                <div class="optotype-option" data-type="C" onclick="selectOpto('C')">
                    <div class="ring-preview c"></div>
                    <div class="name">Landolt C</div>
                    <div class="desc">ISO 8596</div>
                </div>
                <div class="optotype-option" data-type="U" onclick="selectOpto('U')">
                    <div class="square-u-preview"></div>
                    <div class="name">Custom U</div>
                    <div class="desc">Square</div>
                </div>
            </div>
        </div>
        
        <div class="input-group">
            <label>Subject ID *</label>
            <input type="text" id="subjectId" placeholder="Enter Subject ID">
        </div>
        
        <button class="btn btn-primary" onclick="startTest()">Start Test</button>
        <button class="btn btn-outline" onclick="showCal()">üìê Calibrate</button>
        
        <div class="version">v2.1.0 | 2m | ICMR STS 2025</div>
        <div id="syncStatus" class="sync-status online">‚óè Online</div>
    </div>
    
    <!-- Calibration -->
    <div id="calibrationScreen" class="screen">
        <div class="cal-title">üìê Calibration</div>
        <div class="cal-inst">Place <strong>3cm √ó 3cm</strong> card on box. Adjust to match.</div>
        
        <div class="cal-box-wrap">
            <div id="calBox" class="cal-box"></div>
            <div class="cal-label">3√ó3 cm</div>
        </div>
        
        <div class="cal-controls">
            <button onclick="adjCal(-10)">‚àí</button>
            <div class="cal-size" id="calSize">150 px<br><span id="pxCm" style="font-size:11px;color:var(--gray)">50.0 px/cm</span></div>
            <button onclick="adjCal(10)">+</button>
        </div>
        
        <div class="fine-tune">
            <button class="btn btn-outline btn-small" onclick="adjCal(-1)">-1</button>
            <button class="btn btn-outline btn-small" onclick="adjCal(1)">+1</button>
        </div>
        
        <button class="btn btn-success" onclick="saveCal()">‚úì Save</button>
        <button class="btn btn-outline btn-small" onclick="showScr('home')">Cancel</button>
    </div>
    
    <!-- Distance -->
    <div id="distanceScreen" class="screen">
        <div class="dist-icon">üìè</div>
        <div class="dist-title">Test Distance</div>
        <div class="dist-value">2 m</div>
        <div class="dist-inst">Position student <strong>2 meters</strong> from phone screen.</div>
        
        <div class="dist-tips">
            <h4>üí° Setup</h4>
            <ul>
                <li>Phone at eye level</li>
                <li>Mark 2m on floor</li>
                <li>Cover one eye fully</li>
                <li id="optoHint">Tap direction of E</li>
            </ul>
        </div>
        
        <button class="btn btn-primary" onclick="beginTest()">Start</button>
    </div>
    
    <!-- Test -->
    <div id="testScreen" class="screen">
        <div class="test-header">
            <span class="eye-ind" id="eyeInd">Right Eye (OD)</span>
            <span class="prog-text" id="progText">Line 1/11</span>
        </div>
        <div class="acuity-bar" id="acuityBar">LogMAR 1.0 | 6/60 | 29.1mm</div>
        
        <div class="test-area">
            <div class="eye-overlay" id="eyeOverlay">RIGHT EYE</div>
            <div class="tumbling-e" id="tumbE">E</div>
            <div class="landolt-c" id="landC" style="display:none;"></div>
            <div class="square-u" id="squareU" style="display:none;"></div>
        </div>
        
        <div class="feedback-bar" id="feedbackBar"></div>
        
        <div class="dir-buttons">
            <button class="dir-btn up" onclick="respond(90)">‚Üë</button>
            <button class="dir-btn left" onclick="respond(180)">‚Üê</button>
            <button class="dir-btn center" id="trialInfo">1/3</button>
            <button class="dir-btn right" onclick="respond(0)">‚Üí</button>
            <button class="dir-btn down" onclick="respond(270)">‚Üì</button>
            <button class="dir-btn cant" onclick="respond(-1)">‚úï Can't See</button>
        </div>
    </div>
    
    <!-- Results -->
    <div id="resultsScreen" class="screen">
        <div class="check-icon">‚úì</div>
        <div class="title">Complete</div>
        <div id="saveStatus" class="save-status saving">‚è≥ Saving...</div>
        
        <div class="results-card">
            <h2>Results</h2>
            <div class="subj-id" id="subjIdDisp">Subject: ---</div>
            <div class="eye-result">
                <h4>Right Eye (OD)</h4>
                <p id="rLogMAR">LogMAR: ---</p>
                <p id="rSnellen">Snellen: ---</p>
                <p class="dec" id="rDec">Decimal: ---</p>
            </div>
            <div class="eye-result">
                <h4>Left Eye (OS)</h4>
                <p id="lLogMAR">LogMAR: ---</p>
                <p id="lSnellen">Snellen: ---</p>
                <p class="dec" id="lDec">Decimal: ---</p>
            </div>
            <div class="timestamp" id="timeStamp">Tested: ---</div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-success" onclick="restart()">‚úì Next Patient</button>
            <button class="btn btn-primary" onclick="retrySync()" id="retryBtn" style="display:none;">‚Üª Retry</button>
            <button class="btn btn-outline" onclick="share()">Share</button>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>Right Eye Done</h3>
            <p id="modalMsg">Now test LEFT eye.</p>
            <button class="btn btn-primary" onclick="nextEye()">Continue</button>
        </div>
    </div>

    <script>
        const BACKEND = 'https://script.google.com/macros/s/AKfycbyPQ_ajsygSEIVsVcl_oRTij7iXISbeRc-BPUt3se5or8vFNeuwQ60g9IE1NQ8W1dcrqw/exec';
        const STORE_KEY = 'eyescopeai_pending';
        const CAL_KEY = 'eyescopeai_cal';
        const OPTO_KEY = 'eyescopeai_opto';
        
        const CFG = { MAX_WRONG: 2, TRIALS: 3, MIN_PASS: 2, DELAY: 250, DIST_CM: 200, CAL_CM: 3 };
        
        const LOGMAR = [1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.1, 0.0];
        const SNELLEN = ['6/60','6/48','6/38','6/30','6/24','6/19','6/15','6/12','6/9.5','6/7.5','6/6'];
        const SIZE_MM = [29.1, 23.1, 18.4, 14.6, 11.6, 9.2, 7.3, 5.8, 4.6, 3.7, 2.9]; // at 2m
        
        const DIR = { R: 0, U: 90, L: 180, D: 270 };
        const DIRS = [0, 90, 180, 270];
        const DNAME = { 0:'right', 90:'up', 180:'left', 270:'down' };
        
        let opto = 'E';
        let cal = { pxCm: null, boxPx: 150 };
        let st = { subj:'', isRight:true, line:0, trial:0, correct:0, consWrong:0, curDir:0, rLog:-1, lLog:-1, busy:false };
        
        const scr = { home: document.getElementById('homeScreen'), cal: document.getElementById('calibrationScreen'), dist: document.getElementById('distanceScreen'), test: document.getElementById('testScreen'), res: document.getElementById('resultsScreen') };
        const el = {
            subj: document.getElementById('subjectId'),
            calStatus: document.getElementById('calStatus'),
            calBox: document.getElementById('calBox'),
            calSize: document.getElementById('calSize'),
            pxCm: document.getElementById('pxCm'),
            eyeInd: document.getElementById('eyeInd'),
            progText: document.getElementById('progText'),
            acuityBar: document.getElementById('acuityBar'),
            tumbE: document.getElementById('tumbE'),
            landC: document.getElementById('landC'),
            squareU: document.getElementById('squareU'),
            eyeOverlay: document.getElementById('eyeOverlay'),
            feedbackBar: document.getElementById('feedbackBar'),
            trialInfo: document.getElementById('trialInfo'),
            modal: document.getElementById('modal'),
            modalMsg: document.getElementById('modalMsg'),
            saveStatus: document.getElementById('saveStatus'),
            retryBtn: document.getElementById('retryBtn'),
            syncStatus: document.getElementById('syncStatus'),
            pendingBadge: document.getElementById('pendingBadge'),
            optoBadge: document.getElementById('optoBadge'),
            optoHint: document.getElementById('optoHint')
        };
        
        // Optotype
        function selectOpto(t) {
            opto = t;
            localStorage.setItem(OPTO_KEY, t);
            document.querySelectorAll('.optotype-option').forEach(o => o.classList.toggle('selected', o.dataset.type === t));
            const h = { E:'Tap direction of E', C:'Tap direction of gap', U:'Tap direction of opening' };
            el.optoHint.textContent = h[t];
        }
        function loadOpto() { const s = localStorage.getItem(OPTO_KEY); if (s && 'ECU'.includes(s)) selectOpto(s); }
        
        // Calibration
        function loadCal() { try { const s = localStorage.getItem(CAL_KEY); if (s) { cal = JSON.parse(s); updCalStatus(); return true; } } catch(e){} return false; }
        function saveCal() { cal.pxCm = cal.boxPx / CFG.CAL_CM; localStorage.setItem(CAL_KEY, JSON.stringify(cal)); updCalStatus(); showScr('home'); }
        function updCalStatus() {
            if (cal.pxCm) { el.calStatus.className = 'calibration-status calibrated'; el.calStatus.textContent = `‚úì ${cal.pxCm.toFixed(1)} px/cm`; }
            else { el.calStatus.className = 'calibration-status not-calibrated'; el.calStatus.textContent = '‚ö†Ô∏è Not calibrated'; }
        }
        function showCal() { showScr('cal'); updCalBox(); }
        function adjCal(d) { cal.boxPx = Math.max(50, Math.min(400, cal.boxPx + d)); updCalBox(); }
        function updCalBox() {
            el.calBox.style.width = cal.boxPx + 'px';
            el.calBox.style.height = cal.boxPx + 'px';
            el.calSize.innerHTML = cal.boxPx + ' px<br><span style="font-size:11px;color:var(--gray)">' + (cal.boxPx/CFG.CAL_CM).toFixed(1) + ' px/cm</span>';
        }
        
        // Screen
        function showScr(n) {
            Object.values(scr).forEach(s => s.classList.remove('active'));
            scr[n].classList.add('active');
            if (n === 'test') {
                const nm = { E:'Tumbling E', C:'Landolt C', U:'Custom U' };
                el.optoBadge.innerHTML = nm[opto] + ' <span class="dist-badge">2m</span>';
                el.optoBadge.style.display = 'block';
            } else { el.optoBadge.style.display = 'none'; }
        }
        function showModal(b) { el.modal.classList.toggle('active', b); }
        
        // Test
        function startTest() {
            const s = el.subj.value.trim();
            if (!s) { el.subj.classList.add('error'); el.subj.focus(); alert('Enter Subject ID'); return; }
            if (!cal.pxCm) { alert('Calibrate first!'); showCal(); return; }
            el.subj.classList.remove('error');
            st.subj = s;
            showScr('dist');
        }
        function beginTest() { resetSt(); st.isRight = true; showScr('test'); present(); }
        function resetSt() { st.line = 0; st.trial = 0; st.correct = 0; st.consWrong = 0; st.busy = false; }
        function nextEye() { showModal(false); st.isRight = false; resetSt(); present(); }
        function restart() { st.rLog = -1; st.lLog = -1; el.subj.value = ''; showScr('home'); }
        
        // Sizing
        const CAP_RATIO = 0.72;
        function getSizePx(i) { return (SIZE_MM[i] / 10) * cal.pxCm; }
        function getFontPx(i) { return getSizePx(i) / CAP_RATIO; }
        
        // Present
        function present() {
            el.eyeInd.textContent = st.isRight ? 'Right Eye (OD)' : 'Left Eye (OS)';
            el.eyeOverlay.textContent = st.isRight ? 'RIGHT EYE' : 'LEFT EYE';
            el.eyeOverlay.style.background = st.isRight ? 'var(--primary)' : 'var(--accent)';
            el.progText.textContent = `Line ${st.line+1}/${LOGMAR.length}`;
            el.trialInfo.textContent = `${st.trial+1}/${CFG.TRIALS}`;
            el.acuityBar.textContent = `LogMAR ${LOGMAR[st.line].toFixed(1)} | ${SNELLEN[st.line]} | ${SIZE_MM[st.line]}mm`;
            
            st.curDir = DIRS[Math.floor(Math.random()*4)];
            
            el.tumbE.style.display = 'none';
            el.landC.style.display = 'none';
            el.squareU.style.display = 'none';
            
            if (opto === 'E') {
                el.tumbE.style.display = 'block';
                el.tumbE.style.fontSize = getFontPx(st.line) + 'px';
                el.tumbE.style.transform = `rotate(${-st.curDir}deg)`;
            } else if (opto === 'C') {
                const sz = getSizePx(st.line);
                el.landC.style.display = 'block';
                el.landC.style.width = sz + 'px';
                el.landC.style.height = sz + 'px';
                el.landC.className = 'landolt-c gap-' + DNAME[st.curDir];
                el.landC.innerHTML = '<div class="gap"></div>';
            } else {
                const sz = getSizePx(st.line);
                el.squareU.style.display = 'block';
                el.squareU.style.width = sz + 'px';
                el.squareU.style.height = sz + 'px';
                el.squareU.className = 'square-u gap-' + DNAME[st.curDir];
                el.squareU.innerHTML = '<div class="inner"></div>';
            }
            el.feedbackBar.className = 'feedback-bar';
        }
        
        // Beep sound
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(freq = 800, dur = 50) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gain.gain.value = 0.3;
            osc.start();
            setTimeout(() => { osc.stop(); }, dur);
        }
        
        // Response
        function respond(d) {
            if (st.busy) return;
            st.busy = true;
            beep();
            
            const ok = (d === st.curDir);
            const cant = (d === -1);
            
            el.feedbackBar.className = 'feedback-bar ' + (ok ? 'correct' : 'incorrect');
            
            if (ok) { st.correct++; st.consWrong = 0; }
            else { st.consWrong++; }
            
            st.trial++;
            
            if (cant || (st.consWrong >= CFG.MAX_WRONG && st.line > 0)) {
                finish(st.line > 0 ? st.line - 1 : 0);
                return;
            }
            
            if (st.trial >= CFG.TRIALS) {
                if (st.correct >= CFG.MIN_PASS) {
                    st.line++;
                    if (st.line >= LOGMAR.length) { finish(LOGMAR.length - 1); return; }
                } else { finish(st.line > 0 ? st.line - 1 : 0); return; }
                st.trial = 0;
                st.correct = 0;
            }
            
            setTimeout(() => { st.busy = false; present(); }, CFG.DELAY);
        }
        
        function finish(line) {
            const log = LOGMAR[line];
            if (st.isRight) {
                st.rLog = log;
                setTimeout(() => {
                    el.modalMsg.innerHTML = `Right: <strong>${SNELLEN[line]}</strong> (${log.toFixed(1)})<br><br>Now test <strong>LEFT</strong> eye.`;
                    showModal(true);
                }, CFG.DELAY);
            } else {
                st.lLog = log;
                showResults();
            }
        }
        
        // Data
        function buildData() {
            const ri = lineFromLog(st.rLog), li = lineFromLog(st.lLog);
            const nm = { E:'Tumbling E', C:'Landolt C', U:'Custom U' };
            return {
                timestamp: new Date().toISOString(),
                subject_id: st.subj,
                right_eye_logmar: st.rLog.toFixed(1),
                right_eye_snellen: SNELLEN[ri],
                right_eye_decimal: Math.pow(10, -st.rLog).toFixed(2),
                left_eye_logmar: st.lLog.toFixed(1),
                left_eye_snellen: SNELLEN[li],
                left_eye_decimal: Math.pow(10, -st.lLog).toFixed(2),
                test_distance_cm: CFG.DIST_CM,
                screen_ppi: cal.pxCm ? (cal.pxCm * 2.54).toFixed(1) : 'uncal',
                device_info: navigator.userAgent.substring(0, 100),
                optotype_used: nm[opto]
            };
        }
        function lineFromLog(l) { for (let i = 0; i < LOGMAR.length; i++) if (Math.abs(LOGMAR[i] - l) < 0.05) return i; return 0; }
        
        // Backend
        function updOnline() {
            const on = navigator.onLine;
            el.syncStatus.className = 'sync-status ' + (on ? 'online' : 'offline');
            el.syncStatus.textContent = on ? '‚óè Online' : '‚óè Offline';
            if (on) syncPending();
        }
        window.addEventListener('online', updOnline);
        window.addEventListener('offline', updOnline);
        
        function getPending() { try { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); } catch { return []; } }
        function savePending(d) { localStorage.setItem(STORE_KEY, JSON.stringify(d)); updBadge(); }
        function updBadge() { const p = getPending(); el.pendingBadge.textContent = p.length + ' pending'; el.pendingBadge.classList.toggle('show', p.length > 0); }
        
        async function saveToBackend(d) {
            el.saveStatus.className = 'save-status saving';
            el.saveStatus.textContent = '‚è≥ Saving...';
            el.retryBtn.style.display = 'none';
            
            const p = getPending();
            const dId = { ...d, _id: Date.now() };
            p.push(dId);
            savePending(p);
            
            if (!navigator.onLine) { el.saveStatus.className = 'save-status queued'; el.saveStatus.textContent = 'üì± Offline saved'; return; }
            
            try {
                await fetch(BACKEND, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) });
                savePending(getPending().filter(x => x._id !== dId._id));
                el.saveStatus.className = 'save-status saved';
                el.saveStatus.textContent = '‚úì Saved';
            } catch (e) {
                el.saveStatus.className = 'save-status error';
                el.saveStatus.textContent = '‚ö† Failed';
                el.retryBtn.style.display = 'block';
            }
        }
        
        async function syncPending() {
            for (const d of getPending()) {
                try {
                    await fetch(BACKEND, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) });
                    savePending(getPending().filter(x => x._id !== d._id));
                } catch { break; }
            }
            updBadge();
        }
        
        function retrySync() { if (navigator.onLine) { syncPending(); saveToBackend(buildData()); } else alert('Offline'); }
        
        // Results
        function showResults() {
            showScr('res');
            document.getElementById('subjIdDisp').textContent = 'Subject: ' + st.subj;
            const ri = lineFromLog(st.rLog), li = lineFromLog(st.lLog);
            document.getElementById('rLogMAR').textContent = 'LogMAR: ' + st.rLog.toFixed(1);
            document.getElementById('rSnellen').textContent = 'Snellen: ' + SNELLEN[ri];
            document.getElementById('rDec').textContent = 'Decimal: ' + Math.pow(10, -st.rLog).toFixed(2);
            document.getElementById('lLogMAR').textContent = 'LogMAR: ' + st.lLog.toFixed(1);
            document.getElementById('lSnellen').textContent = 'Snellen: ' + SNELLEN[li];
            document.getElementById('lDec').textContent = 'Decimal: ' + Math.pow(10, -st.lLog).toFixed(2);
            document.getElementById('timeStamp').textContent = 'Tested: ' + new Date().toLocaleString();
            saveToBackend(buildData());
        }
        
        function share() {
            const ri = lineFromLog(st.rLog), li = lineFromLog(st.lLog);
            const nm = { E:'Tumbling E', C:'Landolt C', U:'Custom U' };
            const t = `EyeScopeAI v2.0\n${st.subj}\n${nm[opto]} @ 2m\n\nOD: ${SNELLEN[ri]} (${st.rLog.toFixed(1)})\nOS: ${SNELLEN[li]} (${st.lLog.toFixed(1)})`;
            if (navigator.share) navigator.share({ title: 'EyeScopeAI', text: t }).catch(() => {});
            else navigator.clipboard.writeText(t).then(() => alert('Copied')).catch(() => alert(t));
        }
        
        // Init
        loadCal();
        loadOpto();
        updOnline();
        updBadge();
        updCalBox();
        if (navigator.onLine) syncPending();
        console.log('EyeScopeAI v2.1 | 2m | E+C+U | Beep');
    </script>
</body>
</html>
