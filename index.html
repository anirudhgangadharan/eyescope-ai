<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1565C0">
    <title>EyeScopeAI - Vision Screening</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        :root {
            --primary: #1565C0;
            --primary-dark: #0D47A1;
            --accent: #FF6F00;
            --success: #4CAF50;
            --error: #F44336;
            --gray: #9E9E9E;
            --gray-light: #F5F5F5;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Screens */
        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            flex-direction: column;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* Home Screen */
        #homeScreen {
            justify-content: center;
            align-items: center;
            padding: 24px;
            text-align: center;
        }
        
        .logo {
            font-size: 72px;
            margin-bottom: 16px;
        }
        
        .title {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 32px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            width: 100%;
            max-width: 400px;
            text-align: left;
        }
        
        .card h3 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .card p, .card li {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        
        .card ol {
            padding-left: 20px;
        }
        
        .input-group {
            width: 100%;
            max-width: 400px;
            margin-bottom: 24px;
        }
        
        .input-group label {
            display: block;
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .input-group input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .input-group input:focus {
            border-color: var(--primary);
        }
        
        .btn {
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            width: 100%;
            max-width: 400px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-accent {
            background: var(--accent);
            color: white;
        }
        
        .version {
            font-size: 12px;
            color: var(--gray);
            margin-top: 24px;
        }
        
        /* Test Screen */
        #testScreen {
            background: white;
        }
        
        .test-header {
            background: var(--primary);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .eye-indicator {
            font-size: 18px;
            font-weight: bold;
        }
        
        .progress-text {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .acuity-display {
            background: var(--gray-light);
            padding: 8px;
            text-align: center;
            font-size: 12px;
            color: var(--gray);
        }
        
        .test-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 60vh;
            touch-action: none;
        }
        
        .tumbling-e {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: black;
            transition: font-size 0.3s, transform 0.1s;
            line-height: 1;
        }
        
        .direction-hint {
            position: absolute;
            font-size: 24px;
            opacity: 0.3;
            color: var(--gray);
        }
        
        .hint-up { top: 20px; left: 50%; transform: translateX(-50%); }
        .hint-down { bottom: 100px; left: 50%; transform: translateX(-50%); }
        .hint-left { left: 20px; top: 50%; transform: translateY(-50%); }
        .hint-right { right: 20px; top: 50%; transform: translateY(-50%); }
        
        .instructions-bar {
            background: var(--gray-light);
            padding: 16px;
            text-align: center;
            font-size: 16px;
            color: var(--gray);
        }
        
        .feedback-bar {
            height: 8px;
            background: var(--gray-light);
            transition: background-color 0.2s;
        }
        
        .feedback-bar.correct {
            background: var(--success);
        }
        
        .feedback-bar.incorrect {
            background: var(--error);
        }
        
        /* Results Screen */
        #resultsScreen {
            justify-content: center;
            align-items: center;
            padding: 24px;
        }
        
        .check-icon {
            font-size: 64px;
            color: var(--success);
            margin-bottom: 16px;
        }
        
        .results-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            margin-bottom: 24px;
        }
        
        .results-card h2 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 20px;
        }
        
        .subject-id-display {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 16px;
        }
        
        .eye-result {
            background: var(--gray-light);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .eye-result h4 {
            color: var(--primary-dark);
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .eye-result p {
            font-size: 16px;
            margin: 4px 0;
        }
        
        .eye-result .decimal {
            font-size: 14px;
            color: var(--gray);
        }
        
        .timestamp {
            font-size: 12px;
            color: var(--gray);
            margin-top: 16px;
        }
        
        .btn-group {
            width: 100%;
            max-width: 400px;
        }
        
        .btn-group .btn {
            margin-bottom: 12px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 320px;
            text-align: center;
        }
        
        .modal-content h3 {
            color: var(--primary-dark);
            margin-bottom: 16px;
        }
        
        .modal-content p {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        /* Swipe Animation Feedback */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .processing {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <!-- Home Screen -->
    <div id="homeScreen" class="screen active">
        <div class="logo">üëÅÔ∏è</div>
        <div class="title">EyeScopeAI</div>
        <div class="subtitle">Vision Screening Tool</div>
        
        <div class="card">
            <h3>üìã Instructions</h3>
            <ol>
                <li>Hold phone at arm's length (~40cm)</li>
                <li>Cover one eye</li>
                <li>Swipe in the direction the E is pointing</li>
                <li>Test progresses to smaller letters</li>
                <li>Test ends when you cannot see clearly</li>
            </ol>
        </div>
        
        <div class="input-group">
            <label for="subjectId">Name (Optional)</label>
            <input type="text" id="subjectId" placeholder="Enter Name">
        </div>
        
        <button class="btn btn-primary" onclick="startTest()">Start Vision Test</button>
        
        <div class="version">v1.0.0-alpha | ICMR STS 2025</div>
    </div>
    
    <!-- Test Screen -->
    <div id="testScreen" class="screen">
        <div class="test-header">
            <span class="eye-indicator" id="eyeIndicator">Right Eye (OD)</span>
            <span class="progress-text" id="progressText">Line 1/11 | Trial 1/3</span>
        </div>
        
        <div class="acuity-display" id="acuityDisplay">
            LogMAR: 1.0 | Snellen: 6/60 | Decimal: 0.10
        </div>
        
        <div class="test-area" id="testArea">
            <span class="direction-hint hint-up">‚Üë</span>
            <span class="direction-hint hint-down">‚Üì</span>
            <span class="direction-hint hint-left">‚Üê</span>
            <span class="direction-hint hint-right">‚Üí</span>
            
            <div class="tumbling-e" id="tumblingE">E</div>
        </div>
        
        <div class="instructions-bar">
            Swipe in the direction the E is pointing
        </div>
        
        <div class="feedback-bar" id="feedbackBar"></div>
    </div>
    
    <!-- Results Screen -->
    <div id="resultsScreen" class="screen">
        <div class="check-icon">‚úì</div>
        <div class="title">Test Complete</div>
        
        <div class="results-card">
            <h2>Your Results</h2>
            <div class="subject-id-display" id="subjectIdDisplay">Subject ID: ---</div>
            
            <div class="eye-result">
                <h4>Right Eye (OD)</h4>
                <p id="rightLogMAR">LogMAR: ---</p>
                <p id="rightSnellen">Snellen: ---</p>
                <p class="decimal" id="rightDecimal">Decimal VA: ---</p>
            </div>
            
            <div class="eye-result">
                <h4>Left Eye (OS)</h4>
                <p id="leftLogMAR">LogMAR: ---</p>
                <p id="leftSnellen">Snellen: ---</p>
                <p class="decimal" id="leftDecimal">Decimal VA: ---</p>
            </div>
            
            <div class="timestamp" id="timestamp">Tested: ---</div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="restartTest()">Restart Test</button>
            <button class="btn btn-accent" onclick="shareResults()">Share Results</button>
        </div>
    </div>
    
    <!-- Eye Transition Modal -->
    <div id="transitionModal" class="modal">
        <div class="modal-content">
            <h3>Right Eye Complete</h3>
            <p id="transitionMessage">Right Eye Result: 6/60 (LogMAR 1.0)<br><br>Now cover your RIGHT eye for LEFT eye test.</p>
            <button class="btn btn-primary" onclick="continueToLeftEye()">Continue</button>
        </div>
    </div>

    <script>
        // =====================================================
        // EyeScopeAI - Tumbling E Visual Acuity Test
        // ETDRS/LogMAR Standard Implementation
        // =====================================================
        
        // Configuration
        const CONFIG = {
            MAX_WRONG_CONSECUTIVE: 2,  // Stop after 2 consecutive wrong
            TRIALS_PER_LINE: 3,        // 3 trials per LogMAR line
            MIN_CORRECT_TO_PASS: 2,    // Need 2/3 correct to pass line
            BASE_SIZE_VW: 45,          // Base size in vw for LogMAR 1.0
            FEEDBACK_DELAY: 400,       // Delay between trials in ms
            SWIPE_THRESHOLD: 50        // Minimum swipe distance
        };
        
        // LogMAR Scale (11 lines: 1.0 to 0.0)
        const LOGMAR_VALUES = [1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.1, 0.0];
        const SNELLEN_VALUES = ['6/60', '6/48', '6/38', '6/30', '6/24', '6/19', '6/15', '6/12', '6/9.5', '6/7.5', '6/6'];
        
        // Direction constants
        const DIRECTIONS = {
            RIGHT: 0,
            UP: 90,
            LEFT: 180,
            DOWN: 270
        };
        const DIR_ARRAY = [0, 90, 180, 270];
        
        // Test State
        let state = {
            subjectId: '',
            isRightEye: true,
            currentLine: 0,
            trialOnLine: 0,
            correctOnLine: 0,
            consecutiveWrong: 0,
            currentDirection: 0,
            rightEyeLogMAR: -1,
            leftEyeLogMAR: -1,
            isProcessing: false,
            testStartTime: null
        };
        
        // Touch tracking
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        
        // DOM Elements
        const screens = {
            home: document.getElementById('homeScreen'),
            test: document.getElementById('testScreen'),
            results: document.getElementById('resultsScreen')
        };
        
        const elements = {
            subjectIdInput: document.getElementById('subjectId'),
            eyeIndicator: document.getElementById('eyeIndicator'),
            progressText: document.getElementById('progressText'),
            acuityDisplay: document.getElementById('acuityDisplay'),
            testArea: document.getElementById('testArea'),
            tumblingE: document.getElementById('tumblingE'),
            feedbackBar: document.getElementById('feedbackBar'),
            transitionModal: document.getElementById('transitionModal'),
            transitionMessage: document.getElementById('transitionMessage')
        };
        
        // =====================================================
        // Screen Management
        // =====================================================
        
        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
        }
        
        function showModal(show) {
            elements.transitionModal.classList.toggle('active', show);
        }
        
        // =====================================================
        // Test Control Functions
        // =====================================================
        
        function startTest() {
            state.subjectId = elements.subjectIdInput.value.trim() || 
                              'ANON_' + Date.now();
            state.testStartTime = new Date();
            
            resetTestState();
            state.isRightEye = true;
            
            showScreen('test');
            setupTouchListeners();
            presentNextTrial();
        }
        
        function resetTestState() {
            state.currentLine = 0;
            state.trialOnLine = 0;
            state.correctOnLine = 0;
            state.consecutiveWrong = 0;
            state.isProcessing = false;
        }
        
        function continueToLeftEye() {
            showModal(false);
            state.isRightEye = false;
            resetTestState();
            presentNextTrial();
        }
        
        function restartTest() {
            state.rightEyeLogMAR = -1;
            state.leftEyeLogMAR = -1;
            elements.subjectIdInput.value = '';
            showScreen('home');
        }
        
        // =====================================================
        // Trial Presentation
        // =====================================================
        
        function presentNextTrial() {
            // Update UI
            elements.eyeIndicator.textContent = state.isRightEye ? 
                'Right Eye (OD)' : 'Left Eye (OS)';
            
            elements.progressText.textContent = 
                `Line ${state.currentLine + 1}/${LOGMAR_VALUES.length} | Trial ${state.trialOnLine + 1}/${CONFIG.TRIALS_PER_LINE}`;
            
            const currentLogMAR = LOGMAR_VALUES[state.currentLine];
            const decimalVA = Math.pow(10, -currentLogMAR);
            elements.acuityDisplay.textContent = 
                `LogMAR: ${currentLogMAR.toFixed(1)} | Snellen: ${SNELLEN_VALUES[state.currentLine]} | Decimal: ${decimalVA.toFixed(2)}`;
            
            // Randomize direction
            state.currentDirection = DIR_ARRAY[Math.floor(Math.random() * 4)];
            
            // Calculate size (10^0.1 ‚âà 1.2589 ratio between lines)
            const sizeMultiplier = Math.pow(1.2589, state.currentLine);
            const currentSizeVW = CONFIG.BASE_SIZE_VW / sizeMultiplier;
            
            // Apply to E
            elements.tumblingE.style.fontSize = `${currentSizeVW}vw`;
            elements.tumblingE.style.transform = `rotate(${-state.currentDirection}deg)`;
            
            // Reset feedback
            elements.feedbackBar.className = 'feedback-bar';
        }
        
        // =====================================================
        // Touch/Swipe Detection
        // =====================================================
        
        function setupTouchListeners() {
            const testArea = elements.testArea;
            
            testArea.addEventListener('touchstart', handleTouchStart, { passive: true });
            testArea.addEventListener('touchend', handleTouchEnd, { passive: true });
            
            // Also support mouse for testing on desktop
            testArea.addEventListener('mousedown', handleMouseDown);
            testArea.addEventListener('mouseup', handleMouseUp);
        }
        
        function handleTouchStart(e) {
            if (state.isProcessing) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }
        
        function handleTouchEnd(e) {
            if (state.isProcessing) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            processSwipe(touchEndX - touchStartX, touchEndY - touchStartY);
        }
        
        function handleMouseDown(e) {
            if (state.isProcessing) return;
            touchStartX = e.clientX;
            touchStartY = e.clientY;
            touchStartTime = Date.now();
        }
        
        function handleMouseUp(e) {
            if (state.isProcessing) return;
            processSwipe(e.clientX - touchStartX, e.clientY - touchStartY);
        }
        
        function processSwipe(diffX, diffY) {
            const absX = Math.abs(diffX);
            const absY = Math.abs(diffY);
            
            // Check if it's a valid swipe
            if (Math.max(absX, absY) < CONFIG.SWIPE_THRESHOLD) return;
            
            let swipeDirection;
            
            if (absX > absY) {
                // Horizontal swipe
                swipeDirection = diffX > 0 ? DIRECTIONS.RIGHT : DIRECTIONS.LEFT;
            } else {
                // Vertical swipe
                swipeDirection = diffY > 0 ? DIRECTIONS.DOWN : DIRECTIONS.UP;
            }
            
            processResponse(swipeDirection);
        }
        
        // =====================================================
        // Response Processing
        // =====================================================
        
        function processResponse(userDirection) {
            state.isProcessing = true;
            
            const isCorrect = (userDirection === state.currentDirection);
            
            // Visual feedback
            elements.feedbackBar.className = 'feedback-bar ' + 
                (isCorrect ? 'correct' : 'incorrect');
            elements.tumblingE.classList.add('processing');
            
            if (isCorrect) {
                state.correctOnLine++;
                state.consecutiveWrong = 0;
            } else {
                state.consecutiveWrong++;
            }
            
            state.trialOnLine++;
            
            // Check stopping conditions
            if (state.consecutiveWrong >= CONFIG.MAX_WRONG_CONSECUTIVE && state.currentLine > 0) {
                finishCurrentEye(state.currentLine - 1);
                return;
            }
            
            // Check if completed trials for this line
            if (state.trialOnLine >= CONFIG.TRIALS_PER_LINE) {
                if (state.correctOnLine >= CONFIG.MIN_CORRECT_TO_PASS) {
                    // Passed - move to smaller letters
                    state.currentLine++;
                    
                    if (state.currentLine >= LOGMAR_VALUES.length) {
                        finishCurrentEye(LOGMAR_VALUES.length - 1);
                        return;
                    }
                } else {
                    // Failed this line
                    const resultLine = state.currentLine > 0 ? state.currentLine - 1 : 0;
                    finishCurrentEye(resultLine);
                    return;
                }
                
                // Reset for next line
                state.trialOnLine = 0;
                state.correctOnLine = 0;
            }
            
            // Next trial after delay
            setTimeout(() => {
                state.isProcessing = false;
                elements.tumblingE.classList.remove('processing');
                presentNextTrial();
            }, CONFIG.FEEDBACK_DELAY);
        }
        
        // =====================================================
        // Test Completion
        // =====================================================
        
        function finishCurrentEye(finalLine) {
            const logMAR = LOGMAR_VALUES[finalLine];
            
            if (state.isRightEye) {
                state.rightEyeLogMAR = logMAR;
                
                // Show transition modal
                setTimeout(() => {
                    elements.transitionMessage.innerHTML = 
                        `Right Eye Result: ${SNELLEN_VALUES[finalLine]} (LogMAR ${logMAR.toFixed(1)})<br><br>` +
                        `Now cover your <strong>RIGHT</strong> eye for <strong>LEFT</strong> eye test.`;
                    showModal(true);
                }, CONFIG.FEEDBACK_DELAY);
            } else {
                state.leftEyeLogMAR = logMAR;
                showResults();
            }
        }
        
        // =====================================================
        // Results Display
        // =====================================================
        
        function showResults() {
            showScreen('results');
            
            const timestamp = new Date().toLocaleString();
            
            document.getElementById('subjectIdDisplay').textContent = 
                `Subject ID: ${state.subjectId}`;
            
            // Right eye
            if (state.rightEyeLogMAR >= 0) {
                const rightLine = getLineFromLogMAR(state.rightEyeLogMAR);
                const rightDecimal = Math.pow(10, -state.rightEyeLogMAR);
                
                document.getElementById('rightLogMAR').textContent = 
                    `LogMAR: ${state.rightEyeLogMAR.toFixed(1)}`;
                document.getElementById('rightSnellen').textContent = 
                    `Snellen: ${SNELLEN_VALUES[rightLine]}`;
                document.getElementById('rightDecimal').textContent = 
                    `Decimal VA: ${rightDecimal.toFixed(2)}`;
            }
            
            // Left eye
            if (state.leftEyeLogMAR >= 0) {
                const leftLine = getLineFromLogMAR(state.leftEyeLogMAR);
                const leftDecimal = Math.pow(10, -state.leftEyeLogMAR);
                
                document.getElementById('leftLogMAR').textContent = 
                    `LogMAR: ${state.leftEyeLogMAR.toFixed(1)}`;
                document.getElementById('leftSnellen').textContent = 
                    `Snellen: ${SNELLEN_VALUES[leftLine]}`;
                document.getElementById('leftDecimal').textContent = 
                    `Decimal VA: ${leftDecimal.toFixed(2)}`;
            }
            
            document.getElementById('timestamp').textContent = `Tested: ${timestamp}`;
        }
        
        function getLineFromLogMAR(logMAR) {
            for (let i = 0; i < LOGMAR_VALUES.length; i++) {
                if (Math.abs(LOGMAR_VALUES[i] - logMAR) < 0.05) {
                    return i;
                }
            }
            return 0;
        }
        
        // =====================================================
        // Share Functionality
        // =====================================================
        
        function shareResults() {
            const rightLine = getLineFromLogMAR(state.rightEyeLogMAR);
            const leftLine = getLineFromLogMAR(state.leftEyeLogMAR);
            const rightDecimal = Math.pow(10, -state.rightEyeLogMAR);
            const leftDecimal = Math.pow(10, -state.leftEyeLogMAR);
            
            const shareText = 
`EyeScopeAI Vision Test Results
==============================
Subject ID: ${state.subjectId}
Date/Time: ${new Date().toLocaleString()}

RIGHT EYE (OD):
  LogMAR: ${state.rightEyeLogMAR.toFixed(1)}
  Snellen: ${SNELLEN_VALUES[rightLine]}
  Decimal VA: ${rightDecimal.toFixed(2)}

LEFT EYE (OS):
  LogMAR: ${state.leftEyeLogMAR.toFixed(1)}
  Snellen: ${SNELLEN_VALUES[leftLine]}
  Decimal VA: ${leftDecimal.toFixed(2)}

Note: Results for screening purposes only.
Refer to ophthalmologist for clinical evaluation.`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'EyeScopeAI Results',
                    text: shareText
                }).catch(console.error);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Results copied to clipboard!');
                }).catch(() => {
                    alert(shareText);
                });
            }
        }
        
        // =====================================================
        // Prevent accidental navigation
        // =====================================================
        
        window.addEventListener('beforeunload', (e) => {
            if (screens.test.classList.contains('active')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        // Prevent zoom on double tap
        document.addEventListener('dblclick', (e) => e.preventDefault());
        
        console.log('EyeScopeAI v1.0.0-alpha initialized');
    </script>
</body>
</html>
